# API Gateway Configuration for AgentHub Microservices
upstream analytics_service {
    server analytics-service:8002;
}

upstream billing_service {
    server billing-service:8003;
}

upstream dashboard_service {
    server dashboard-service:8004;
}

upstream widget_service {
    server widget-service:8005;
}

upstream my_agents_service {
    server my-agents-service:8006;
}

upstream insights_service {
    server insights-service:8007;
}

upstream agent_wizard_service {
    server agent-wizard-service:8001;
}

upstream rag_knowledge_service {
    server rag-knowledge-service:8008;
}

upstream payment_processing_service {
    server payment-processing-service:8011;
}

server {
    listen 80;
    server_name localhost;

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "API Gateway Healthy\n";
        add_header Content-Type text/plain;
    }

    # Analytics Service
    location /api/analytics/ {
        proxy_pass http://analytics_service/api/analytics/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Billing Service
    location /api/billing/ {
        proxy_pass http://billing_service/api/billing/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Dashboard Service
    location /api/dashboard/ {
        proxy_pass http://dashboard_service/api/dashboard/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Widget Service
    location /api/widgets/ {
        proxy_pass http://widget_service/api/widgets/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # My Agents Service
    location /api/my-agents/ {
        proxy_pass http://my_agents_service/api/my-agents/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Insights Service
    location /api/insights/ {
        proxy_pass http://insights_service/api/insights/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Agent Wizard Service
    location /api/agents/ {
        proxy_pass http://agent_wizard_service/api/agents/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # RAG Knowledge Service
    location /api/rag/ {
        proxy_pass http://rag_knowledge_service/api/rag/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Payment Processing Service
    location /api/payments/ {
        proxy_pass http://payment_processing_service/api/payments/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Default route
    location / {
        return 404 "Route not found";
    }
}